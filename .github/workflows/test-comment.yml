name: PR Test via Comment

on:
  issue_comment:
    types: [created]

env:
  CI_TEST_REPO: https://github.com/free5gc/ci-test
  CI_TEST_DIR: ci-test
  GO_VERSION: '1.24.5'

jobs:
  pr-test:
    name: PR Test from Comment
    if: contains(github.event.comment.body, '#test')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Parse test command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const match = comment.match(/#test\s+(.+?)(?:\n|$)/);
            
            if (!match) {
              core.setFailed('Invalid format. Use: #test <nf_name> <pr_number> ...');
              return;
            }
            
            const args = match[1].trim();
            console.log(`Parsed arguments: ${args}`);
            core.setOutput('args', args);
            core.setOutput('valid', 'true');

      - name: Add rocket reaction
        if: steps.parse.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Setup Go
        if: steps.parse.outputs.valid == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          
      - name: Setup Docker
        if: steps.parse.outputs.valid == 'true'
        run: |
          # Docker Âú® ubuntu-latest Â∑≤È†êË£ùÔºåÁ¢∫Ë™çÁâàÊú¨
          docker --version
          docker compose version
          
          # ÂïüÂãï Docker daemon (Â¶ÇÊûúÈúÄË¶Å)
          sudo systemctl start docker || true
          
      - name: Install dependencies
        if: steps.parse.outputs.valid == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq git
          
      - name: Verify environment
        if: steps.parse.outputs.valid == 'true'
        run: |
          echo "=== Environment Check ==="
          echo "Go version:"
          go version
          echo ""
          echo "Docker version:"
          docker --version
          echo ""
          echo "Docker Compose version:"
          docker compose version
          echo ""
          echo "Other tools:"
          curl --version | head -1
          jq --version
          git --version

      - name: Clone ci-test repository
        if: steps.parse.outputs.valid == 'true'
        run: |
          rm -rf ${{ env.CI_TEST_DIR }}
          git clone ${{ env.CI_TEST_REPO }} ${{ env.CI_TEST_DIR }}

      - name: Run ci-operation-pr.sh
        id: run_test
        if: steps.parse.outputs.valid == 'true'
        run: |
          cd ${{ env.CI_TEST_DIR }}
          chmod +x ci-operation-pr.sh
          
          echo "Running: ./ci-operation-pr.sh nf ${{ steps.parse.outputs.args }}"
          
          # Âü∑Ë°å‰∏¶ÊçïÁç≤Ëº∏Âá∫
          ./ci-operation-pr.sh nf ${{ steps.parse.outputs.args }} 2>&1 | tee test_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          
          # ÂÑ≤Â≠òÊúÄÂæå 200 Ë°åËº∏Âá∫
          echo "output<<EOF" >> $GITHUB_OUTPUT
          tail -200 test_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          exit $EXIT_CODE

      - name: Upload test report
        if: always() && steps.parse.outputs.valid == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-test-report-${{ github.run_id }}
          path: |
            ${{ env.CI_TEST_DIR }}/testing_output/
            ${{ env.CI_TEST_DIR }}/test_output.txt
          if-no-files-found: ignore

      - name: Post success result
        if: success() && steps.parse.outputs.valid == 'true'
        uses: actions/github-script@v7
        env:
          TEST_OUTPUT: ${{ steps.run_test.outputs.output }}
          TEST_ARGS: ${{ steps.parse.outputs.args }}
        with:
          script: |
            const output = process.env.TEST_OUTPUT || '';
            const args = process.env.TEST_ARGS;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const body = [
              '## ‚úÖ PR Test Passed',
              '',
              `**Test Command:** \`#test ${args}\``,
              '',
              '<details>',
              '<summary>üìã Test Output (click to expand)</summary>',
              '',
              '```',
              output.slice(-3000),
              '```',
              '',
              '</details>',
              '',
              `[View full workflow run](${runUrl})`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: body
            });

      - name: Post failure result
        if: failure() && steps.parse.outputs.valid == 'true'
        uses: actions/github-script@v7
        env:
          TEST_OUTPUT: ${{ steps.run_test.outputs.output }}
          TEST_ARGS: ${{ steps.parse.outputs.args }}
        with:
          script: |
            const output = process.env.TEST_OUTPUT || 'No output captured';
            const args = process.env.TEST_ARGS;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const body = [
              '## ‚ùå PR Test Failed',
              '',
              `**Test Command:** \`#test ${args}\``,
              '',
              '<details>',
              '<summary>üìã Test Output (click to expand)</summary>',
              '',
              '```',
              output.slice(-3000),
              '```',
              '',
              '</details>',
              '',
              `[View full workflow run](${runUrl})`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: body
            });

      - name: Cleanup
        if: always() && steps.parse.outputs.valid == 'true'
        run: |
          echo "Cleaning up..."
          docker system prune -f || true
          rm -rf ${{ env.CI_TEST_DIR }}