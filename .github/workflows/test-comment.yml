name: PR Test via Comment

on:
  issue_comment:
    types: [created]

env:
  CI_TEST_REPO: https://github.com/free5gc/ci-test
  CI_TEST_DIR: ci-test
  GO_VERSION: '1.24.5'
  WAIT_TIMEOUT: 600

jobs:
  pr-test:
    name: PR Test from Comment
    if: contains(github.event.comment.body, '#test')
    # é‡è¦ï¼šfree5gc æ¸¬è©¦éœ€è¦ self-hosted runner
    # å› ç‚ºéœ€è¦å®‰è£ gtp5g kernel module å’Œè¨­å®š Linux network
    # å¦‚æœæ²’æœ‰ self-hosted runnerï¼Œå¯ä»¥æ”¹ç”¨ ubuntu-latest ä½†åªèƒ½è·‘ Docker æ¸¬è©¦
    runs-on: [self-hosted, linux, x64]
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Parse test command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const match = comment.match(/#test\s+(.+?)(?:\n|$)/);
            
            if (!match) {
              core.setFailed('Invalid format. Use: #test <nf_name> <pr_number> ...');
              return;
            }
            
            const args = match[1].trim();
            console.log(`Parsed arguments: ${args}`);
            core.setOutput('args', args);
            core.setOutput('valid', 'true');

      - name: Add rocket reaction
        if: steps.parse.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Check system requirements
        if: steps.parse.outputs.valid == 'true'
        run: |
          echo "=== System Requirements Check ==="
          echo "Docker:"
          docker --version
          docker compose version
          echo ""
          echo "Go:"
          go version
          echo ""
          echo "Tools:"
          curl --version | head -1
          jq --version
          git --version
          echo ""
          echo "Kernel modules (gtp5g):"
          lsmod | grep gtp5g || echo "gtp5g not loaded (will be loaded by test)"
          echo ""
          echo "Network interfaces:"
          ip link show | grep -E "^[0-9]+" | head -10

      - name: Clone ci-test repository
        if: steps.parse.outputs.valid == 'true'
        run: |
          rm -rf ${{ env.CI_TEST_DIR }}
          git clone ${{ env.CI_TEST_REPO }} ${{ env.CI_TEST_DIR }}

      - name: Run ci-operation-pr.sh
        id: run_test
        if: steps.parse.outputs.valid == 'true'
        run: |
          cd ${{ env.CI_TEST_DIR }}
          chmod +x ci-operation-pr.sh
          
          echo "========================================"
          echo "Running: ./ci-operation-pr.sh nf ${{ steps.parse.outputs.args }}"
          echo "========================================"
          
          # åŸ·è¡Œä¸¦æ•ç²è¼¸å‡º
          set +e
          ./ci-operation-pr.sh nf ${{ steps.parse.outputs.args }} 2>&1 | tee test_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # å„²å­˜æœ€å¾Œ 300 è¡Œè¼¸å‡º
          echo "output<<EOF" >> $GITHUB_OUTPUT
          tail -300 test_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # å„²å­˜é€€å‡ºç¢¼
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          exit $EXIT_CODE

      - name: Upload test report
        if: always() && steps.parse.outputs.valid == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-test-report-${{ github.run_id }}
          path: |
            ${{ env.CI_TEST_DIR }}/testing_output/
            ${{ env.CI_TEST_DIR }}/test_output.txt
          if-no-files-found: ignore
          retention-days: 7

      - name: Post success result
        if: success() && steps.parse.outputs.valid == 'true'
        uses: actions/github-script@v7
        env:
          TEST_OUTPUT: ${{ steps.run_test.outputs.output }}
          TEST_ARGS: ${{ steps.parse.outputs.args }}
        with:
          script: |
            const output = process.env.TEST_OUTPUT || '';
            const args = process.env.TEST_ARGS;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const body = [
              '## âœ… PR Test Passed',
              '',
              `**Test Command:** \`#test ${args}\``,
              '',
              '<details>',
              '<summary>ğŸ“‹ Test Output (click to expand)</summary>',
              '',
              '```',
              output.slice(-4000),
              '```',
              '',
              '</details>',
              '',
              `ğŸ“ [View full workflow run](${runUrl})`,
              `ğŸ“¦ [Download test artifacts](${runUrl}#artifacts)`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: body
            });

      - name: Post failure result
        if: failure() && steps.parse.outputs.valid == 'true'
        uses: actions/github-script@v7
        env:
          TEST_OUTPUT: ${{ steps.run_test.outputs.output }}
          TEST_ARGS: ${{ steps.parse.outputs.args }}
        with:
          script: |
            const output = process.env.TEST_OUTPUT || 'No output captured';
            const args = process.env.TEST_ARGS;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const body = [
              '## âŒ PR Test Failed',
              '',
              `**Test Command:** \`#test ${args}\``,
              '',
              '<details>',
              '<summary>ğŸ“‹ Test Output (click to expand)</summary>',
              '',
              '```',
              output.slice(-4000),
              '```',
              '',
              '</details>',
              '',
              `ğŸ“ [View full workflow run](${runUrl})`,
              `ğŸ“¦ [Download test artifacts](${runUrl}#artifacts)`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: body
            });

      - name: Cleanup docker resources
        if: always() && steps.parse.outputs.valid == 'true'
        run: |
          echo "Cleaning up docker resources..."
          docker system prune -f || true
          docker volume prune -f || true

      - name: Clean up repositories
        if: always() && steps.parse.outputs.valid == 'true'
        run: |
          rm -rf ${{ env.CI_TEST_DIR }}
